<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>construct the discharge route model · HydroModels.jl</title><meta name="title" content="construct the discharge route model · HydroModels.jl"/><meta property="og:title" content="construct the discharge route model · HydroModels.jl"/><meta property="twitter:title" content="construct the discharge route model · HydroModels.jl"/><meta name="description" content="Documentation for HydroModels.jl."/><meta property="og:description" content="Documentation for HydroModels.jl."/><meta property="twitter:description" content="Documentation for HydroModels.jl."/><meta property="og:url" content="https://chooron.github.io/HydroModels.jl/dev/implements/build_discharge_route_en/"/><meta property="twitter:url" content="https://chooron.github.io/HydroModels.jl/dev/implements/build_discharge_route_en/"/><link rel="canonical" href="https://chooron.github.io/HydroModels.jl/dev/implements/build_discharge_route_en/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="../../assets/icon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HydroModels.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><a class="tocitem" href="../../get_start_en/">Get Started with HydroModels.jl</a></li><li><span class="tocitem">tutorials</span><ul><li><a class="tocitem" href="../../tutorials/framework_design/">Framework Design</a></li><li><a class="tocitem" href="../../tutorials/neuralnetwork_embeding/">Neural Network Embedding</a></li><li><a class="tocitem" href="../../tutorials/distribute_modeling/">Distribute Modeling</a></li><li><a class="tocitem" href="../../tutorials/optimimal_parameters/">Optimal Parameters</a></li></ul></li><li><a class="tocitem" href="../../concepts_en/">Basic Concepts</a></li><li><span class="tocitem">Model Implementations</span><ul><li><a class="tocitem" href="../build_exphydro_model_en/">construct the ExpHydro Model</a></li><li><a class="tocitem" href="../build_m50_model_en/">construct the M50 Model</a></li><li class="is-active"><a class="tocitem" href>construct the discharge route model</a><ul class="internal"><li><a class="tocitem" href="#Mathematical-Formulation"><span>Mathematical Formulation</span></a></li><li><a class="tocitem" href="#Implementation-in-HydroModels.jl"><span>Implementation in HydroModels.jl</span></a></li></ul></li></ul></li><li><span class="tocitem">Extend Contents</span><ul><li><a class="tocitem" href="../../extent/why_not_MTK_en/">Why not using ModelingToolkit.jl directly</a></li><li><a class="tocitem" href="../../extent/framework_comparision_en/">Framework Comparision</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Model Implementations</a></li><li class="is-active"><a href>construct the discharge route model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>construct the discharge route model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl/blob/main/docs/src/implements/build_discharge_route_en.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Building-a-Discharge-Routing-Model"><a class="docs-heading-anchor" href="#Building-a-Discharge-Routing-Model">Building a Discharge Routing Model</a><a id="Building-a-Discharge-Routing-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Building-a-Discharge-Routing-Model" title="Permalink"></a></h1><h2 id="Mathematical-Formulation"><a class="docs-heading-anchor" href="#Mathematical-Formulation">Mathematical Formulation</a><a id="Mathematical-Formulation-1"></a><a class="docs-heading-anchor-permalink" href="#Mathematical-Formulation" title="Permalink"></a></h2><p>The discharge routing model is based on the following equations:</p><p class="math-container">\[\begin{aligned}
\frac{dS_{rf,n}}{dt} &amp;= Q_{rf,up} - Q_{rf,n} &amp;&amp; (1) \\
Q_{rf,n} &amp;= \frac{S_{rf,n}}{\text{LAG}_{rf}} + Q_{rf,n-1} &amp;&amp; (2) \\
Q_{rf,up} &amp;= \sum_{i \in up(n)} Q_{rf,i} &amp;&amp; (3) \\
Q_{rf} &amp;= Q_{rf,n} + (R_{sw} + R_{gw}) \cdot A_{gc} &amp;&amp; (4)
\end{aligned}\]</p><p>where <span>$n$</span> is the reach index, ranging from <span>${1,...,c_{max}}$</span>; <span>$\Delta S_{rf,n}$</span> is the storage change in reach n; <span>$Q_{rf,n}$</span> is the outflow from reach n; <span>$S_{rf,n}$</span> is the storage in reach n; <span>$\text{LAG}_{rf}$</span> is the routing lag parameter; <span>$Q_{rf,up}$</span> is the inflow from upstream reaches; <span>$R_{sw}$</span> and <span>$R_{gw}$</span> are surface and groundwater runoff; <span>$A_{gc}$</span> is the grid cell area; <span>$c_{max}$</span> is the maximum number of reaches.</p><p>The equations describe: (1) storage change in the reach, (2) reach outflow calculation, (3) upstream inflow accumulation, and (4) final discharge calculation. This approach determines the inflow to each Hydrological Response Unit (HRU) based on its upstream inputs, which can be represented using two different routing functions. The outflow from the current HRU is calculated using the current reach storage <span>$S_{rf,n}$</span> and combined with the HRU&#39;s <span>$R_{sw}$</span> and <span>$R_{gw}$</span> (after area conversion) to obtain the final discharge <span>$Q_{rf}$</span>.</p><h2 id="Implementation-in-HydroModels.jl"><a class="docs-heading-anchor" href="#Implementation-in-HydroModels.jl">Implementation in HydroModels.jl</a><a id="Implementation-in-HydroModels.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Implementation-in-HydroModels.jl" title="Permalink"></a></h2><h3 id="Modified-Calculation-Formula"><a class="docs-heading-anchor" href="#Modified-Calculation-Formula">Modified Calculation Formula</a><a id="Modified-Calculation-Formula-1"></a><a class="docs-heading-anchor-permalink" href="#Modified-Calculation-Formula" title="Permalink"></a></h3><p>In the HydroModels.jl framework, this storage-based discharge calculation method is represented by the HydroRoute type, which solves the problem continuously through ODE equations. The implementation differs from the original formula in that it assumes no instantaneous changes when calculating <span>$Q_{rf,n}$</span>, transforming equation (2) into:</p><p class="math-container">\[\begin{aligned}
Q_{rf,n} &amp;= S_{rf,n} \cdot \frac{1}{\text{LAG}_{rf} + 1} &amp;&amp; (5)
\end{aligned}\]</p><p>The <span>$Q_{rf,n-1}$</span> term is removed because in continuous change, <span>$S_{rf,n}$</span> is constantly evolving, making it unnecessary to consider <span>$Q_{rf,n-1}$</span> in calculating <span>$Q_{rf,n}$</span>. Additionally, there are dimensional differences between <span>$S_{rf,n}$</span> and <span>$Q_{rf,n}$</span>, and including <span>$Q_{rf,n}$</span> would add an instantaneous state variable, which is unsuitable as a state variable. In HydroRoute construction, the primary focus is expressing the outflow calculation formula. Like HydroBucket, HydroRoute accepts HydroFlux to represent the <span>$Q_{rf,n}$</span> calculation formula:</p><pre><code class="language-julia hljs">using HydroModels
# Define parameters and variables
@variables q q_routed s_river
@parameters lag
# Define routing flux
rflux = HydroFlux([q, s_river] =&gt; [q_routed], [lag], exprs=[s_river / (1 + lag) + q])</code></pre><h3 id="Flow-Accumulation-Functions"><a class="docs-heading-anchor" href="#Flow-Accumulation-Functions">Flow Accumulation Functions</a><a id="Flow-Accumulation-Functions-1"></a><a class="docs-heading-anchor-permalink" href="#Flow-Accumulation-Functions" title="Permalink"></a></h3><p>The method of obtaining upstream flow inputs is another crucial component of the routing model. Flow accumulation functions are typically used to calculate the upstream inflow for each HRU. This accumulation can be represented using either Grid-Based or Vector-Based approaches, corresponding to two types of HydroRoute construction in HydroModels.jl: GridRoute and VectorRoute.</p><h4 id="Vector-Based-Routing-Model"><a class="docs-heading-anchor" href="#Vector-Based-Routing-Model">Vector-Based Routing Model</a><a id="Vector-Based-Routing-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Vector-Based-Routing-Model" title="Permalink"></a></h4><p>The Vector-Based routing model is based on watershed subdivision and topological relationships, using an adjacency matrix for flow accumulation:</p><pre><code class="language-julia hljs">using Graphs
# Build river network topology
network = DiGraph(9)
add_edge!(network, 1, 2)
add_edge!(network, 2, 5)
add_edge!(network, 3, 5)
add_edge!(network, 4, 5)
add_edge!(network, 5, 8)
add_edge!(network, 6, 9)
add_edge!(network, 7, 8)
add_edge!(network, 8, 9)
vroute = HydroModels.VectorRoute(rfunc=rflux, rstate=s_river, network=network)</code></pre><p>The code uses Graphs.jl&#39;s DiGraph data structure to represent watershed topology, which, along with the constructed rflux and s_river, completes the Vector-Based routing model construction.</p><h4 id="Grid-Based-Routing-Model"><a class="docs-heading-anchor" href="#Grid-Based-Routing-Model">Grid-Based Routing Model</a><a id="Grid-Based-Routing-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Grid-Based-Routing-Model" title="Permalink"></a></h4><p>The Grid-Based routing model represents HRU connectivity using a D8 flow direction matrix. The construction is based on the D8 matrix and corresponding HRU coordinates:</p><pre><code class="language-julia hljs"># Build river network topology
flwdir = [1 4 8; 1 4 4; 1 1 2]
positions = [[1, 1], [1, 2], [1, 3], [2, 1], [2, 2], [2, 3], [3, 1], [3, 2], [3, 3]]
groute = HydroModels.GridRoute(rfunc=rflux, rstate=s_river, flwdir=flwdir, positions=positions)</code></pre><p>The code uses matrix data to represent flow direction and HRU coordinates, which, combined with the constructed rflux and s_river, completes the Grid-Based routing model construction.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../build_m50_model_en/">« construct the M50 Model</a><a class="docs-footer-nextpage" href="../../extent/why_not_MTK_en/">Why not using ModelingToolkit.jl directly »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Monday 8 September 2025 14:10">Monday 8 September 2025</span>. Using Julia version 1.11.6.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
