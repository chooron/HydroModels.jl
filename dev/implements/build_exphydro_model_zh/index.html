<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>构建ExpHydro模型 · HydroModels.jl</title><meta name="title" content="构建ExpHydro模型 · HydroModels.jl"/><meta property="og:title" content="构建ExpHydro模型 · HydroModels.jl"/><meta property="twitter:title" content="构建ExpHydro模型 · HydroModels.jl"/><meta name="description" content="Documentation for HydroModels.jl."/><meta property="og:description" content="Documentation for HydroModels.jl."/><meta property="twitter:description" content="Documentation for HydroModels.jl."/><meta property="og:url" content="https://chooron.github.io/HydroModels.jl/dev/implements/build_exphydro_model_zh/"/><meta property="twitter:url" content="https://chooron.github.io/HydroModels.jl/dev/implements/build_exphydro_model_zh/"/><link rel="canonical" href="https://chooron.github.io/HydroModels.jl/dev/implements/build_exphydro_model_zh/"/><script data-outdated-warner src="../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../search_index.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">HydroModels.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Run Models</span><ul><li><a class="tocitem" href="../../tutorials/run_exphydro_model/">Run ExpHydro Model</a></li></ul></li><li><a class="tocitem" href="../../concepts_en/">Basic Concepts</a></li><li><span class="tocitem">Model Implementations</span><ul><li><a class="tocitem" href="../build_exphydro_model_en/">construct the ExpHydro Model</a></li><li><a class="tocitem" href="../build_m50_model_en/">construct the M50 Model</a></li><li><a class="tocitem" href="../build_discharge_route_en/">construct the discharge route model</a></li></ul></li><li><span class="tocitem">Extend Contents</span><ul><li><a class="tocitem" href="../../extent/why_not_MTK_en/">Why not using ModelingToolkit.jl directly</a></li><li><a class="tocitem" href="../../extent/framework_comparision_en/">Framework Comparision</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>构建ExpHydro模型</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>构建ExpHydro模型</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl/blob/main/docs/src/implements/build_exphydro_model_zh.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="构建ExpHydro模型"><a class="docs-heading-anchor" href="#构建ExpHydro模型">构建ExpHydro模型</a><a id="构建ExpHydro模型-1"></a><a class="docs-heading-anchor-permalink" href="#构建ExpHydro模型" title="Permalink"></a></h1><h2 id="ExpHydro模型介绍"><a class="docs-heading-anchor" href="#ExpHydro模型介绍">ExpHydro模型介绍</a><a id="ExpHydro模型介绍-1"></a><a class="docs-heading-anchor-permalink" href="#ExpHydro模型介绍" title="Permalink"></a></h2><p>本节将基于 HydroModels.jl 构建一个结构较为简单的水文模型-ExpHydro 模型,以此来开启概念式模型搭建的教程。 首先对 ExpHydro 模型进行介绍,该模型由 Snowpack Bucket 和 Soilwater Bucket 两个计算模块组成,其计算公式如下：</p><p class="math-container">\[\begin{aligned}
&amp; \text{Snowpack Bucket:} \\
&amp; pet = 29.8 \cdot lday \cdot 24 \cdot 0.611 \cdot \frac{\exp(17.3 \cdot temp)}{temp + 237.3} \cdot \frac{1}{temp + 273.2} &amp;&amp; (1) \\
&amp; snowfall = H(T_{min} - temp) \cdot prcp &amp;&amp; (2) \\
&amp; rainfall = H(temp - T_{min}) \cdot prcp &amp;&amp; (3) \\
&amp; melt = H(temp - T_{max}) \cdot H(snowpack) \cdot \min(snowpack, D_f \cdot (temp - T_{max})) &amp;&amp; (4) \\
&amp; \frac{d(snowpack)}{dt} = snowfall - melt &amp;&amp; (5) \\
\\
&amp; \text{Soilwater Bucket:} \\
&amp; evap = H(soilwater) \cdot pet \cdot \min(1.0, \frac{soilwater}{S_{max}}) &amp;&amp; (6) \\
&amp; baseflow = H(soilwater) \cdot Q_{max} \cdot \exp(-f \cdot \max(0.0, S_{max} - soilwater)) &amp;&amp; (7) \\
&amp; surfaceflow = \max(0.0, soilwater - S_{max}) &amp;&amp; (8) \\
&amp; flow = baseflow + surfaceflow &amp;&amp; (9) \\
&amp; \frac{d(soilwater)}{dt} = rainfall + melt - evap - flow &amp;&amp; (10)
\end{aligned}\]</p><p>其中:</p><ul><li><p class="math-container">\[H(x)\]</p>表示Heaviside阶跃函数，当 <span>$x &gt; 0$</span> 时为1，否则为0</li><li><p class="math-container">\[T_{min}, T_{max}, D_f, S_{max}, Q_{max}, f\]</p>为模型参数</li><li><p class="math-container">\[temp, lday, prcp\]</p>为输入变量</li><li><p class="math-container">\[snowpack, soilwater\]</p>为状态变量</li><li>其余变量为中间计算变量</li></ul><h2 id="完整的模型构建过程"><a class="docs-heading-anchor" href="#完整的模型构建过程">完整的模型构建过程</a><a id="完整的模型构建过程-1"></a><a class="docs-heading-anchor-permalink" href="#完整的模型构建过程" title="Permalink"></a></h2><pre><code class="language-julia hljs"># import packages
using HydroModels

# define variables and parameters
@variables temp lday pet prcp 
@variables snowfall rainfall melt evap baseflow surfaceflow flow
@variables snowpack soilwater
@parameters Tmin Tmax Df Smax Qmax f

# define snowpack bucket
fluxes_1 = [
    HydroFlux([temp, lday] =&gt; [pet], exprs=[29.8 * lday * 24 * 0.611 * exp((17.3 * temp) / (temp + 237.3)) / (temp + 273.2)]),
    HydroFlux([prcp, temp] =&gt; [snowfall, rainfall], [Tmin], exprs=[step_func(Tmin - temp) * prcp, step_func(temp - Tmin) * prcp]),
    HydroFlux([snowpack, temp] =&gt; [melt], [Tmax, Df], exprs=[step_func(temp - Tmax) * step_func(snowpack) * min(snowpack, Df * (temp - Tmax))]),
]
dfluxes_1 = [StateFlux([snowfall] =&gt; [melt], snowpack),]
snowpack_bucket = HydroBucket(name=:surface, funcs=fluxes_1, dfuncs=dfluxes_1)

# define soilwater bucket
fluxes_2 = [
    HydroFlux([soilwater, pet] =&gt; [evap], [Smax], exprs=[step_func(soilwater) * pet * min(1.0, soilwater / Smax)]),
    HydroFlux([soilwater] =&gt; [baseflow], [Smax, Qmax, f], exprs=[step_func(soilwater) * Qmax * exp(-f * (max(0.0, Smax - soilwater)))]),
    HydroFlux([soilwater] =&gt; [surfaceflow], [Smax], exprs=[max(0.0, soilwater - Smax)]),
    HydroFlux([baseflow, surfaceflow] =&gt; [flow], exprs=[baseflow + surfaceflow]),
]
dfluxes_2 = [StateFlux([rainfall, melt] =&gt; [evap, flow], soilwater)]
soilwater_bucket = HydroBucket(name=:soil, funcs=fluxes_2, dfuncs=dfluxes_2)

# define the Exp-Hydro model
exphydro_model = HydroModel(name=:exphydro, components=[snowpack_bucket, soilwater_bucket])</code></pre><h2 id="分段剖析"><a class="docs-heading-anchor" href="#分段剖析">分段剖析</a><a id="分段剖析-1"></a><a class="docs-heading-anchor-permalink" href="#分段剖析" title="Permalink"></a></h2><p>接下来我们将分块对模型构建过程进行介绍.</p><p>首先需要引入HydroModels.jl的依赖:</p><pre><code class="language-julia hljs">using HydroModels</code></pre><p>通过导入HydroModels模块,可以直接访问HydroFlux,StateFlux,HydroBucket,HydroModel等模块定义的类型,同时还该包导出了ModelingToolkit.jl包中@variables,@parameters等宏,可以用于水文模型中变量和参数的定义和操作, 如下所示:</p><pre><code class="language-julia hljs">@variables temp lday prcp 
@variables snowfall rainfall melt evap baseflow surfaceflow flow pet
@variables snowpack soilwater
@parameters Tmin Tmax Df Smax Qmax f</code></pre><p>在这段代码中,需要将ExpHydro模型中所有变量进行定义,包括输入变量温度(<code>temp</code>),日照时长(<code>lday</code>)和降水(<code>prcp</code>),同时给出了ExpHydro模型中所有变量的中间计算变量,如<code>pet</code>, <code>snowfall</code>, <code>rainfall</code>, <code>melt</code>, <code>evap</code>, <code>baseflow</code>, <code>surfaceflow</code>, <code>flow</code>等,以及ExpHydro模型的状态变量<code>snowpack</code>和<code>soilwater</code>,<code>以及ExpHydro模型的参数Tmin</code>, <code>Tmax</code>, <code>Df</code>, <code>Smax</code>, <code>Qmax</code>和<code>f</code>.</p><p><code>HydroFlux</code>的定义需要根据计算公式确定模型的输入输出变量和模型参数,例如在模型的雨雪划分计算公式,该公式的输入变量为<code>prcp</code>和<code>temp</code>,输出变量为<code>snowfall</code>和<code>rainfall</code>,模型参数为<code>Tmin</code>, 公式转译为<code>HydroFlux</code>的结果如下所示:</p><pre><code class="language-julia hljs"># 定义平滑函数
step_func(x) = (tanh(5.0 * x) + 1.0) * 0.5
# 定义雨雪划分函数
split_flux = HydroFlux([prcp, temp] =&gt; [snowfall, rainfall], [Tmin], exprs=[step_func(Tmin - temp) * prcp, step_func(temp - Tmin) * prcp])</code></pre><p><code>StateFlux</code>的定义是根据状态变量的平衡方程, 一般来说平衡方程是状态变量的变化率等于输入输出通量的差值得到,例如<code>snowpack</code>的平衡方程是<code>snowfall</code>和<code>melt</code>的差值, 公式转译为<code>StateFlux</code>的结果如下所示:</p><pre><code class="language-julia hljs">snowpack_dflux = StateFlux([snowfall] =&gt; [melt], snowpack)</code></pre><p>接着根据模型计算公式通过<code>HydroFlux</code>和<code>StateFlux</code>进行定义, 并将其整合为<code>HydroBucket</code>,得到Snowpack Bucket和Soilwater Bucket如下所示:</p><pre><code class="language-julia hljs"># define snowpack bucket
fluxes_1 = [
    HydroFlux([temp, lday] =&gt; [pet], exprs=[29.8 * lday * 24 * 0.611 * exp((17.3 * temp) / (temp + 237.3)) / (temp + 273.2)]),
    HydroFlux([prcp, temp] =&gt; [snowfall, rainfall], [Tmin], exprs=[step_func(Tmin - temp) * prcp, step_func(temp - Tmin) * prcp]),
    HydroFlux([snowpack, temp] =&gt; [melt], [Tmax, Df], exprs=[step_func(temp - Tmax) * step_func(snowpack) * min(snowpack, Df * (temp - Tmax))]),
]
dfluxes_1 = [StateFlux([snowfall] =&gt; [melt], snowpack),]
snowpack_bucket = HydroBucket(name=:surface, funcs=fluxes_1, dfuncs=dfluxes_1)

# define soilwater bucket
fluxes_2 = [
    HydroFlux([soilwater, pet] =&gt; [evap], [Smax], exprs=[step_func(soilwater) * pet * min(1.0, soilwater / Smax)]),
    HydroFlux([soilwater] =&gt; [baseflow], [Smax, Qmax, f], exprs=[step_func(soilwater) * Qmax * exp(-f * (max(0.0, Smax - soilwater)))]),
    HydroFlux([soilwater] =&gt; [surfaceflow], [Smax], exprs=[max(0.0, soilwater - Smax)]),
    HydroFlux([baseflow, surfaceflow] =&gt; [flow], exprs=[baseflow + surfaceflow]),
]
dfluxes_2 = [StateFlux([rainfall, melt] =&gt; [evap, flow], soilwater)]
soilwater_bucket = HydroBucket(name=:soil, funcs=fluxes_2, dfuncs=dfluxes_2)</code></pre><p><code>HydroBucket</code>的构建由<code>HydroFlux</code>和<code>StateFlux</code>组成, 其中<code>HydroFlux</code>用于定义模型的计算公式,<code>StateFlux</code>用于定义状态变量的平衡方程.</p><p>最后将<code>HydroBucket</code>组合成<code>HydroModel</code>,作为components输入到模型中,得到ExpHydro模型如下所示:</p><pre><code class="language-julia hljs"># define the Exp-Hydro model
exphydro_model = HydroModel(name=:exphydro, components=[snowpack_bucket, soilwater_bucket])</code></pre></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.8.0 on <span class="colophon-date" title="Wednesday 18 December 2024 09:19">Wednesday 18 December 2024</span>. Using Julia version 1.11.2.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
