<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Understanding DeepFlex.jl Framework Concepts · HydroModels.jl</title><meta name="title" content="Understanding DeepFlex.jl Framework Concepts · HydroModels.jl"/><meta property="og:title" content="Understanding DeepFlex.jl Framework Concepts · HydroModels.jl"/><meta property="twitter:title" content="Understanding DeepFlex.jl Framework Concepts · HydroModels.jl"/><meta name="description" content="Documentation for HydroModels.jl."/><meta property="og:description" content="Documentation for HydroModels.jl."/><meta property="twitter:description" content="Documentation for HydroModels.jl."/><meta property="og:url" content="https://chooron.github.io/HydroModels.jl/dev/framework_concepts/"/><meta property="twitter:url" content="https://chooron.github.io/HydroModels.jl/dev/framework_concepts/"/><link rel="canonical" href="https://chooron.github.io/HydroModels.jl/dev/framework_concepts/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script><link href="../assets/icon.ico" rel="icon" type="image/x-icon"/></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">HydroModels.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../get_start_en/">Get Started with HydroModels.jl</a></li><li><span class="tocitem">tutorials</span><ul><li><a class="tocitem" href="../tutorials/framework_design/">Framework Design</a></li><li><a class="tocitem" href="../tutorials/neuralnetwork_embeding/">Neural Network Embedding</a></li><li><a class="tocitem" href="../tutorials/distribute_modeling/">Distribute Modeling</a></li><li><a class="tocitem" href="../tutorials/optimimal_parameters/">Optimal Parameters</a></li></ul></li><li><a class="tocitem" href="../concepts_en/">Basic Concepts</a></li><li><span class="tocitem">Model Implementations</span><ul><li><a class="tocitem" href="../implements/build_exphydro_model_en/">construct the ExpHydro Model</a></li><li><a class="tocitem" href="../implements/build_m50_model_en/">construct the M50 Model</a></li><li><a class="tocitem" href="../implements/build_discharge_route_en/">construct the discharge route model</a></li></ul></li><li><span class="tocitem">Extend Contents</span><ul><li><a class="tocitem" href="../extent/why_not_MTK_en/">Why not using ModelingToolkit.jl directly</a></li><li><a class="tocitem" href="../extent/framework_comparision_en/">Framework Comparision</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Understanding DeepFlex.jl Framework Concepts</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Understanding DeepFlex.jl Framework Concepts</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/chooron/HydroModels.jl/blob/main/docs/src/framework_concepts.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Understanding-DeepFlex.jl-Framework-Concepts"><a class="docs-heading-anchor" href="#Understanding-DeepFlex.jl-Framework-Concepts">Understanding DeepFlex.jl Framework Concepts</a><a id="Understanding-DeepFlex.jl-Framework-Concepts-1"></a><a class="docs-heading-anchor-permalink" href="#Understanding-DeepFlex.jl-Framework-Concepts" title="Permalink"></a></h1><p>This document aims to clarify the core concepts of the DeepFlex.jl framework, focusing on the three fundamental components: Flux, Element/Bucket, and Model. Understanding these components and their relationships is essential for effectively using the framework to build hydrological models.</p><h2 id="Framework-Architecture-Overview"><a class="docs-heading-anchor" href="#Framework-Architecture-Overview">Framework Architecture Overview</a><a id="Framework-Architecture-Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Framework-Architecture-Overview" title="Permalink"></a></h2><p>DeepFlex.jl is built on a modular architecture that enables flexible hydrological model construction. The framework is designed around three core components that work together to create comprehensive hydrological simulations:</p><ol><li><strong>Flux</strong>: The basic computational units that define mathematical relationships</li><li><strong>Element/Bucket</strong>: Storage components that integrate multiple fluxes and manage state variables</li><li><strong>Model</strong>: The top-level structure that combines all components into a complete simulation system</li></ol><p>This hierarchical design allows for both simple conceptual models and complex physically-based or hybrid models to be constructed using the same framework.</p><h2 id="Flux:-The-Building-Blocks"><a class="docs-heading-anchor" href="#Flux:-The-Building-Blocks">Flux: The Building Blocks</a><a id="Flux:-The-Building-Blocks-1"></a><a class="docs-heading-anchor-permalink" href="#Flux:-The-Building-Blocks" title="Permalink"></a></h2><p>Fluxes are the fundamental computational units in DeepFlex.jl. They define the mathematical relationships between variables in a hydrological system. There are three main types of flux components:</p><h3 id="1.-HydroFlux"><a class="docs-heading-anchor" href="#1.-HydroFlux">1. HydroFlux</a><a id="1.-HydroFlux-1"></a><a class="docs-heading-anchor-permalink" href="#1.-HydroFlux" title="Permalink"></a></h3><p><code>HydroFlux</code> represents a simple mathematical relationship between input and output variables. It uses symbolic expressions to define how outputs are calculated from inputs.</p><p><strong>Key characteristics:</strong></p><ul><li>Defines explicit mathematical formulas</li><li>Handles parameter-based calculations</li><li>Supports both single-node and multi-node simulations</li><li>Type-stable implementation for computational efficiency</li></ul><p><strong>Example:</strong></p><pre><code class="language-julia hljs"># Define a simple rainfall-runoff relationship
rainfall_flux = @hydroflux runoff ~ k * rainfall</code></pre><h3 id="2.-StateFlux"><a class="docs-heading-anchor" href="#2.-StateFlux">2. StateFlux</a><a id="2.-StateFlux-1"></a><a class="docs-heading-anchor-permalink" href="#2.-StateFlux" title="Permalink"></a></h3><p><code>StateFlux</code> defines how state variables change over time. These are used to create differential equations that are solved during simulation.</p><p><strong>Key characteristics:</strong></p><ul><li>Defines state variable dynamics (dS/dt)</li><li>Forms the basis of ordinary differential equations (ODEs)</li><li>Integrates with ODE solvers for time evolution</li><li>Essential for water balance calculations</li></ul><p><strong>Example:</strong></p><pre><code class="language-julia hljs"># Define how soil moisture changes over time
soil_flux = @stateflux soilwater ~ rainfall - evaporation - runoff</code></pre><h3 id="3.-NeuralFlux"><a class="docs-heading-anchor" href="#3.-NeuralFlux">3. NeuralFlux</a><a id="3.-NeuralFlux-1"></a><a class="docs-heading-anchor-permalink" href="#3.-NeuralFlux" title="Permalink"></a></h3><p><code>NeuralFlux</code> integrates neural networks into the hydrological modeling framework. This allows for data-driven components to be seamlessly combined with process-based equations.</p><p><strong>Key characteristics:</strong></p><ul><li>Connects neural networks to hydrological processes</li><li>Enables hybrid modeling approaches</li><li>Maintains the same interface as traditional fluxes</li><li>Supports Lux.jl neural network models</li></ul><p><strong>Example:</strong></p><pre><code class="language-julia hljs"># Define a neural network-based evaporation model
evap_nn = Chain(Dense(3 =&gt; 16, tanh), Dense(16 =&gt; 1))
evap_flux = @neuralflux evaporation ~ evap_nn([temperature, humidity, radiation])</code></pre><h2 id="Element/Bucket:-The-Storage-Components"><a class="docs-heading-anchor" href="#Element/Bucket:-The-Storage-Components">Element/Bucket: The Storage Components</a><a id="Element/Bucket:-The-Storage-Components-1"></a><a class="docs-heading-anchor-permalink" href="#Element/Bucket:-The-Storage-Components" title="Permalink"></a></h2><p>Elements are higher-level components that integrate multiple fluxes and manage state variables. The primary type of element in DeepFlex.jl is the <code>Bucket</code>.</p><h3 id="HydroBucket"><a class="docs-heading-anchor" href="#HydroBucket">HydroBucket</a><a id="HydroBucket-1"></a><a class="docs-heading-anchor-permalink" href="#HydroBucket" title="Permalink"></a></h3><p>A <code>HydroBucket</code> represents a storage component with state variables that change over time according to input and output fluxes. It encapsulates both water movement processes and state evolution equations.</p><p><strong>Key characteristics:</strong></p><ul><li>Integrates multiple flux components</li><li>Manages state variables and their dynamics</li><li>Handles ODE solving for time evolution</li><li>Supports both single-node and distributed (multi-node) simulations</li><li>Automatically generates optimized functions for calculations</li></ul><p><strong>Example:</strong></p><pre><code class="language-julia hljs"># Define a snow accumulation and melt bucket
snow_bucket = @hydrobucket :snow begin
    fluxes = begin
        @hydroflux snowfall ~ step_func(Tmin - temp) * prcp
        @hydroflux rainfall ~ step_func(temp - Tmin) * prcp
        @hydroflux melt ~ step_func(temp - Tmax) * step_func(snowpack) * min(snowpack, Df * (temp - Tmax))
    end
    dfluxes = begin
        @stateflux snowpack ~ snowfall - melt
    end
end</code></pre><p>In this example, the snow bucket:</p><ol><li>Calculates snowfall, rainfall, and snowmelt fluxes</li><li>Defines how the snowpack state variable changes over time</li><li>Automatically handles the integration of these processes during simulation</li></ol><h3 id="HydroRoute"><a class="docs-heading-anchor" href="#HydroRoute">HydroRoute</a><a id="HydroRoute-1"></a><a class="docs-heading-anchor-permalink" href="#HydroRoute" title="Permalink"></a></h3><p>Another type of element is <code>HydroRoute</code>, which handles water routing through a network of connected nodes.</p><p><strong>Key characteristics:</strong></p><ul><li>Manages flow calculations and inter-node water transfer</li><li>Supports network-based routing</li><li>Handles both local flow calculations and downstream routing</li><li>Can incorporate parameter-based or neural network-based routing schemes</li></ul><h2 id="Model:-The-Integration-Framework"><a class="docs-heading-anchor" href="#Model:-The-Integration-Framework">Model: The Integration Framework</a><a id="Model:-The-Integration-Framework-1"></a><a class="docs-heading-anchor-permalink" href="#Model:-The-Integration-Framework" title="Permalink"></a></h2><p>The <code>HydroModel</code> is the top-level structure that integrates multiple components (fluxes and elements) into a complete simulation system.</p><p><strong>Key characteristics:</strong></p><ul><li>Combines multiple components into a cohesive system</li><li>Automatically handles connections between components</li><li>Determines the correct execution order based on dependencies</li><li>Manages data flow between components</li><li>Provides a unified interface for simulation</li></ul><p><strong>Example:</strong></p><pre><code class="language-julia hljs"># Create a complete hydrological model
complete_model = @hydromodel :watershed_model begin
    snow_bucket
    soil_bucket
    routing_component
end</code></pre><p>The model automatically:</p><ol><li>Analyzes dependencies between components</li><li>Creates a computational graph for efficient execution</li><li>Manages state variables across the entire model</li><li>Prepares the model for simulation with various solver options</li></ol><h2 id="How-Components-Work-Together"><a class="docs-heading-anchor" href="#How-Components-Work-Together">How Components Work Together</a><a id="How-Components-Work-Together-1"></a><a class="docs-heading-anchor-permalink" href="#How-Components-Work-Together" title="Permalink"></a></h2><p>The power of DeepFlex.jl comes from how these components work together:</p><ol><li><strong>Fluxes</strong> define the mathematical relationships and processes</li><li><strong>Buckets/Elements</strong> integrate these fluxes and manage state variables</li><li><strong>Models</strong> combine multiple elements into a complete simulation system</li></ol><p>This hierarchical structure allows for:</p><ul><li>Modular model construction</li><li>Flexible component combination</li><li>Seamless integration of process-based and data-driven approaches</li><li>Efficient computation for both simple and complex models</li></ul><h2 id="Execution-Process"><a class="docs-heading-anchor" href="#Execution-Process">Execution Process</a><a id="Execution-Process-1"></a><a class="docs-heading-anchor-permalink" href="#Execution-Process" title="Permalink"></a></h2><p>When running a model in DeepFlex.jl, the following steps occur:</p><ol><li><p><strong>Data Preparation</strong>:</p><ul><li>Input data is organized as a matrix (features × time)</li><li>Parameters are provided as a ComponentVector</li><li>Initial states are specified</li></ul></li><li><p><strong>Configuration</strong>:</p><ul><li>Solver selection (e.g., from DifferentialEquations.jl)</li><li>Interpolation method (e.g., from DataInterpolations.jl)</li><li>Time indices for output</li></ul></li><li><p><strong>Execution</strong>:</p><ul><li>Components are executed in dependency order</li><li>State variables are integrated over time</li><li>Fluxes are calculated at each time step</li><li>Results are collected and organized</li></ul></li><li><p><strong>Output</strong>:</p><ul><li>Time series of state variables</li><li>Time series of output fluxes</li><li>Additional diagnostic information</li></ul></li></ol><h2 id="Practical-Example:-ExpHydro-Model"><a class="docs-heading-anchor" href="#Practical-Example:-ExpHydro-Model">Practical Example: ExpHydro Model</a><a id="Practical-Example:-ExpHydro-Model-1"></a><a class="docs-heading-anchor-permalink" href="#Practical-Example:-ExpHydro-Model" title="Permalink"></a></h2><p>To illustrate how these concepts work together, let&#39;s examine the ExpHydro model implementation:</p><pre><code class="language-julia hljs"># Define variables and parameters
@variables temp lday prcp pet snowfall rainfall snowpack melt
@variables soilwater evap baseflow surfaceflow flow
@parameters Tmin Tmax Df Smax Qmax f

# Define the snow component
snow_bucket = @hydrobucket :snow begin
    fluxes = begin
        @hydroflux pet ~ 29.8 * lday * 24 * 0.611 * exp((17.3 * temp) / (temp + 237.3)) / (temp + 273.2)
        @hydroflux snowfall ~ step_func(Tmin - temp) * prcp
        @hydroflux rainfall ~ step_func(temp - Tmin) * prcp
        @hydroflux melt ~ step_func(temp - Tmax) * step_func(snowpack) * min(snowpack, Df * (temp - Tmax))
    end
    dfluxes = begin
        @stateflux snowpack ~ snowfall - melt
    end
end

# Define the soil water component
soil_bucket = @hydrobucket :soil begin
    fluxes = begin
        @hydroflux evap ~ step_func(soilwater) * pet * min(1.0, soilwater / Smax)
        @hydroflux baseflow ~ step_func(soilwater) * Qmax * exp(-f * (max(0.0, Smax - soilwater)))
        @hydroflux surfaceflow ~ max(0.0, soilwater - Smax)
        @hydroflux flow ~ baseflow + surfaceflow
    end
    dfluxes = begin
        @stateflux soilwater ~ (rainfall + melt) - (evap + flow)
    end
end

# Combine components into a complete model
exphydro_model = @hydromodel :exphydro begin
    snow_bucket
    soil_bucket
end</code></pre><p>In this example:</p><ol><li><strong>Fluxes</strong> define processes like snowfall, rainfall, melt, evaporation, and runoff</li><li><strong>Buckets</strong> integrate these fluxes into snow and soil water components</li><li><strong>Model</strong> combines these components into a complete ExpHydro model</li></ol><p>The framework automatically handles the connections between components, such as using the rainfall and melt outputs from the snow bucket as inputs to the soil bucket.</p><h2 id="Conclusion"><a class="docs-heading-anchor" href="#Conclusion">Conclusion</a><a id="Conclusion-1"></a><a class="docs-heading-anchor-permalink" href="#Conclusion" title="Permalink"></a></h2><p>Understanding the relationships between Flux, Element/Bucket, and Model components is essential for effectively using the DeepFlex.jl framework. These components provide a flexible and powerful system for building hydrological models of varying complexity, from simple conceptual models to complex physically-based or hybrid models.</p><p>By leveraging this modular architecture, modelers can:</p><ul><li>Build models from reusable components</li><li>Combine process-based and data-driven approaches</li><li>Create efficient and type-stable implementations</li><li>Support both single-node and distributed simulations</li></ul><p>This framework design enables a wide range of hydrological modeling applications while maintaining computational efficiency and scientific rigor.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.10.2 on <span class="colophon-date" title="Friday 2 May 2025 02:07">Friday 2 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
